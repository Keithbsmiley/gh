#!/usr/bin/env python

import signal
import sys
import os.path
import os
# from argparse import ArgumentParser
# from helpers import credentials
# from json import dumps
# from requests import post
# from webbrowser import open_new_tab
from subprocess import check_output

URL = "https://api.github.com/repos/%s/%s/pulls"
NETRC_MACHINE = "api.github.com"


def signal_handle(sig, frame):
    sys.exit(0)


def current_branch_name():
    return check_output("git symbolic-ref --short HEAD".split()).strip()


def repo_username():
    url_parts = origin_url().split("/")
    return filter_empty_string(url_parts)[-2]


def filter_empty_string(array):
    return [a for a in array if len(a) > 0]


def origin_url():
    return check_output("git config --get remote.origin.url".split()).strip()


def git_directory():
    return check_output("git rev-parse -q --git-dir".split()).strip()


def pr_message_file():
    return os.path.join(git_directory(), "PULLREQUEST_EDITMSG")


def remote_branch_name(branch="master"):
    return "%s:%s" % (repo_username(), branch)


def last_commit_message():
    message = check_output("git log --format=%B -n 1".split()).strip()
    return commit_from_string(message)


def commit_from_string(string):
    values = map(str.strip, string.split("\n", 1))
    if len(values) < 2:
        values.append(None)
    return values


def pr_message():
    file_path = pr_message_file()
    title, body = last_commit_message()
    with open(file_path, "w") as f:
        f.write(title + "\n\n" + body + "\n")
        f.write("\n# This will be stuff\n")

    command = 'vim -c "set ft=gitcommit" %s' % file_path
    code = os.system(command)
    if code != 0:
        sys.exit("Not submitting PR")

    f = open(file_path, "r")
    text = f.read()
    f.close()

    return commit_from_string(text)


signal.signal(signal.SIGINT, signal_handle)
if __name__ == '__main__':
    print pr_message()
